<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]>      <html class="no-js"> <!--<![endif]-->
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>JS Recorder</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
    <script src="https://kit.fontawesome.com/0955c01d8d.js" crossorigin="anonymous"></script>
    <style>
        body {
            background: #d9dadc;
            width: 318px;
            height: 235px;
            overflow-x: hidden;
            overflow-y: hidden;
            border: 5px solid;
            border-radius: 3px;
            border-color: #708198;
        }
        
        .container {
            padding-top: 10px;
            padding-left: 0px;
            padding-right: 0px;
            background-color: #d9dadc;
            margin: 0;
        }
        
        .fa-circle,
        .fa-pause,
        .fa-square {
            color: #67605f;
        }
        
        #player {
            width: 100%;
            margin: 0 auto;
        }
        
        #save-btn {
            width: 100%;
            margin: 0 auto;
            background-color: #708198;
        }
        
        .deleteBtn {
            width: 100%;
            margin: 0 auto;
            background-color: #67605f;
            color: #fff;
        }
        
        .visualizer {
            height: 60px;
            width: 100%;
        }
        
        #resumeBtn {
            display: none;
            color: #67605f;
        }
    </style>

</head>

<body>
    <!--[if lt IE 7]>
            <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a href="#">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <div id="recorderContainer" class="container rounded mh-100">
        <div id="buttonLabels" class="row align-items-center">
            <div id="recordLabel" class="col-sm col-4 text-center">
                <h6>Record</h6>
            </div>
            <div id="pauseLabel" class="col-sm col-4 text-center">
                <h6>Pause</h6>
            </div>
            <div id="stopLabel" class="col-sm col-4 text-center">
                <h6>Stop</h6>
            </div>
        </div>
        <div id="recorderButtons" class="row align-items-center">
            <div class="col-sm col-4 text-center">
                <button id="record" class='btn'>
                <span class="fa-stack">
                    
                        <i class="fas fa-circle fa-stack-2x"></i></i>
                        <i class="fas fa-microphone fa-stack-1x fa-inverse" ></i>
                   
                </span>
            </button>
            </div>
            <div class="col-sm col-4 text-center">
                <button id="pause" class='btn'>
                <i class="fas fa-pause fa-2x"></i>
                </button>

            </div>
            <div class="col-sm col-4 text-center">
                <button id="stop" class='btn'>
                <i class="fas fa-square fa-2x"></i>
            </button>
            </div>
        </div>
        <div id="playback" class="row align-items-center">
            <div id="player" class="col-sm col-12 ">
                <section id="basicUsage">

                </section>
                <section class="sound-clips">

                </section>
            </div>
        </div>
        <div id="saveAudio" class="row align-items-center">
            <div id="saver" class="col-sm col-12">

            </div>
        </div>
    </div>
    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="https://rawcdn.githack.com/albert-gonzalez/easytimer.js/153c4c4d2d88a9c3db8dd5a112d1247b8f0ab39f/dist/easytimer.min.js"></script>
    <script type="text/javascript" src="https://rawcdn.githack.com/picasocro1/mic-recorder-to-mp3/5cd2ad73e1ee766b750996d557254f12849f3d28/dist/index.js" crossorigin="anonymous"></script>
    <script>
        const LABELS = {

            PAUSE: '<i class="fas fa-pause fa-2x"></i>',
            RESUME: 'Resume'
        };
        var timer = new easytimer.Timer();

        const startButton = document.getElementById('record');
        const pauseButton = document.getElementById('pause');
        const stopButton = document.getElementById('stop');
        const soundClips = document.querySelector('.sound-clips');
        const recorder = new MicRecorder({
            bitRate: 180
        });

        startButton.disabled = false;
        stopButton.disabled = true;
        pauseButton.disabled = true;


        startButton.addEventListener('click', startRecording);
        stopButton.addEventListener('click', stopRecording);
        pauseButton.addEventListener('click', pauseRecording);

        function startRecording() {


            recorder.start().then(() => {
                if (pauseButton.innerHTML !== LABELS.RESUME) {
                    startButton.disabled = true;
                    stopButton.disabled = false;
                    document.querySelector(".fas.fa-square.fa-2x").style.color = "red";
                    pauseButton.disabled = false;
                } else {
                    pauseButton.innerHTML = LABELS.PAUSE;
                    pauseButton.removeEventListener('click', startRecording);
                    pauseButton.addEventListener('click', pauseRecording);
                }
                timer.start();
                timer.addEventListener('secondsUpdated', function(e) {

                    document.getElementById('basicUsage').innerHTML = "<h5>" + timer.getTimeValues().toString() + "</h5>";
                });

            }).catch((e) => {
                console.error(e);
            });
        }

        function pauseRecording() {
            timer.pause();
            recorder.pause().then(() => {
                pauseButton.innerHTML = LABELS.RESUME;
                pauseButton.removeEventListener('click', pauseRecording);
                pauseButton.addEventListener('click', startRecording);
            }).catch((e) => {
                console.error(e);
            });
        }

        function stopRecording() {
            timer.stop();
            document.getElementById("basicUsage").innerHTML = "";
            recorder.stop().getMp3().then(([buffer, blob]) => {
                console.log(buffer, blob);
                pauseButton.innerHTML = LABELS.PAUSE;
                pauseButton.disabled = true;
                stopButton.disabled = true;
                startButton.disabled = false;
                document.querySelector(".fas.fa-square.fa-2x").style.color = "#67605f";

                var clipContainer = document.createElement('article');
                var clipName = new Date().toISOString() + "_Legacy Audio Recording.mp3";

                var audio = document.createElement('audio');
                var deleteButton = document.createElement('button');


                clipContainer.classList.add('clip');
                audio.setAttribute('controls', '');
                deleteButton.classList.add('btn');
                deleteButton.classList.add('deleteBtn');

                deleteButton.innerHTML = "Delete";


                clipContainer.appendChild(audio);

                clipContainer.appendChild(deleteButton);
                soundClips.appendChild(clipContainer);

                const file = new File(buffer, clipName, {
                    type: blob.type,
                    lastModified: Date.now()
                });
                audio.src = URL.createObjectURL(file);
                audio.controls = true;
                var link = document.createElement('a');
                link.id = "savingLink";
                link.href = audio.src;
                link.download = clipName;
                link.innerHTML = "<button id='save-btn' class='btn'>Save Audio</button>";
                document.getElementById("saver").appendChild(link);

                deleteButton.onclick = function(e) {
                    timer.reset();
                    let evtTgt = e.target;
                    evtTgt.parentNode.parentNode.removeChild(evtTgt.parentNode);
                    document.getElementById("saver").removeChild(document.getElementById("savingLink"));
                    timer.stop();
                    timer.addEventListener('reset', function(e) {
                        document.getElementById("basicUsage").innerHTML = "<h5>" + timer.getTimeValues().toString() + "</h5>";;
                    });
                }


            }).catch((e) => {
                console.error(e);
            });
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>
</body>

</html>